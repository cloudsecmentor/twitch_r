library(tidyverse)
library(lubridate)

data.dir <- "./vulnerability_management/data/"


### single data file
inventory <-
read_csv(str_c(data.dir, "inventory-2021-02-16.csv"))

vuln_data <-
read_csv(str_c(data.dir, "vuln-2021-02-16.csv"))


CVSS <- 1:10

cvss_score <- function (CVSS) {
  ifelse(CVSS <4, "2 Low",
         ifelse(CVSS < 7, "1 Medium","0 High"))
}

cvss_score(CVSS)

vuln_posture <-
inventory %>%
  full_join(vuln_data, by= c("vmname" = "target")) %>%
  mutate( CVSS.Score = cvss_score(CVSS))

## the most vulnerable servers in PRD
vuln_posture %>%
  count(vmname, environment, CVSS.Score) %>%
  filter(str_detect(environment, "PRD")) %>%
  filter(str_detect(CVSS.Score, "High")) %>%
  arrange(desc(n))

## the number of HIGH vulnerabilities total
vuln_posture %>%
  filter(str_detect(CVSS.Score, "High")) %>%
  count(vulns, CVSS) %>%
  arrange(desc(n))

## the number of vulnerabilities per environment
vuln_posture %>%
  count(environment, CVSS.Score) 

## the number of vulnerable VMs per environment
vuln_posture %>%
  count(environment, vmname, CVSS.Score) %>%
  select(-n) %>%
  count(environment, CVSS.Score)



## multiple data files

convert_filename_date <- function(v,begins){
  v %>%
    str_remove(begins) %>%
    str_remove(".csv") %>%
    ymd()
}
"vuln-2021-02-16.csv" %>%
  convert_filename_date("vuln-")


import_data_multiple <-function(data.dir, begins){
  data.dir %>%
    list.files() %>%
    tibble(filename = .) %>%
    filter(str_detect(filename,begins)) %>%
    mutate(file = str_c(data.dir,filename)) %>%
    mutate (data = map(file, read_csv)) %>%
    select(-file) %>%
    mutate(report.date = convert_filename_date(filename, begins)) %>%
    unnest(data)
  
} 

scan.all.data <-
  data.dir %>%
  import_data_multiple("vuln-")

inv.all.data <-
  data.dir %>%
  import_data_multiple("inventory-")
